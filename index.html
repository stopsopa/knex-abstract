<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Test</title>
    <style>
        * {
            font-family: "Andale Mono",AndaleMono,monospace;
            font-size: 11px;
        }
        table {
            width: 98%;
            border: 1px solid gray;
        }
        .level {
            border: 1px solid lightgray;
            padding-left: 7px;
        }
        .level > div > .level {
            margin-left: 30px;
            margin-bottom: 1px;
        }
        .valid {
            color: green;
        }
        .invalid {
            color: red;
        }
        .level > .id {
            color: darkcyan;
        }
        .level > .le {
            background-color: #0056ff;
            color: white;
            padding-left: 3px;
            padding-right: 3px;
            border-radius: 10px;
        }
        .level > .l {
            position: relative;
            background-color: brown;
            color: white;
            padding-left: 1px;
            padding-right: 3px;
            /*border-top-left-radius: 3px;*/
            /*border-bottom-left-radius: 3px;*/
        }
        .level > .l::before {
            position: absolute;
            top: 0px;
            border-right: 4px solid brown;
            border-bottom: 6px solid transparent;
            border-top: 6px solid transparent;
            border-left: 4px solid transparent;
            content: "";
            left: -8px;
        }
        .level > .r {
            position: relative;
            background-color: blueviolet;
            color: white;
            padding-left: 3px;
            padding-right: 1px;
            /*border-top-right-radius: 3px;*/
            /*border-bottom-right-radius: 3px;*/
        }
        .level > .r::before {
            position: absolute;
            top: 0px;
            border-right: 4px solid transparent;
            border-bottom: 6px solid transparent;
            border-top: 6px solid transparent;
            border-left: 4px solid blueviolet;
            content: "";
            right: -8px;
        }
        .level > .s {
            color: #a98823;
        }
        button {
            background-color: #a5a5a5;
            color: white;
            border-radius: 1px;
            margin-left: 5px;
            margin-right: 5px;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: gray;
        }
    </style>
</head>
<body>

    <table>
        <tbody>
        <tr>
            <td>
    <div id="app">
        Loading ...
    </div>
            </td>
            <td>
    <pre></pre>

            </td>
        </tr>

        </tbody>
    </table>
    <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
    <script src="node_modules/react/umd/react.production.min.js"></script>
    <script src="node_modules/react-dom/umd/react-dom.production.min.js"></script>
    <script src="node_modules/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">

        const now = () => (new Date()).toISOString().substring(0, 19).replace('T', ' ');

        const log           =   (function(){try{return console.log}catch(e){return function(){}}}());

        const pre           =   document.querySelector('pre');

        const delay = (time, data) =>
            new Promise(
                resolve => time ? setTimeout(resolve, time, data) : resolve(data)
            )
        ;

        const {
            Component,
            Fragment,
        } = React;

        class Level extends Component {
            render () {

                const {
                    tree,
                    onCopy          = () => {},
                    onCut           = () => {},
                    onPasteAfter    = () => {},
                    onPasteBefore   = () => {},
                    onPasteToStart  = () => {},
                    onPasteToEnd    = () => {},
                    onPasteToZeroN  = () => {},
                    onDelete        = () => {},

                    clipboard,
                } = this.props;

                return (
                    <div>
                        {tree.map(c => (
                            <Fragment key={c.id}>
                                <div className="level">
                                    <span className="id">#{c.id}</span> <span className="l">{c.l}</span><span className="r">{c.r}</span> <span className="le">{c.le}</span> <span className="s">{c.s}</span>: <b>{c.title}</b>
                                    <span>
                                        <button onClick={() => onDelete(c.id)}>delete</button>
                                        <button onClick={() => onCopy(c.id)}>copy</button>
                                        <button onClick={() => onCut(c.id)}>cut</button> :
                                        {clipboard && (
                                            <>
                                                <button onClick={() => onPasteAfter(c.id)}>onPasteAfter</button>
                                            </>
                                        )}
                                    </span>
                                    {
                                        Array.isArray(c.children) &&
                                            <Level
                                                {...this.props}
                                                tree={c.children}
                                            />
                                    }
                                </div>
                            </Fragment>
                        ))}
                    </div>
                );
            }
        }

        const socket        =   io();

        class Root extends React.Component {
            constructor(...args) {

                super(...args);

                this.state = {
                    tree: [],
                    clipboard: false,
                }
            }
            componentDidMount() {

                const connect = () => {

                    // to make sure it will be triggered only once
                    socket.removeListener('connect', connect);

                    const n = now();

                    log('connected...: ', n);

                    socket.on('data', data => {
                        pre.innerHTML = JSON.stringify(data, null, 4);
                    });

                    socket.on('tobrowser', data => {
                        log('tobrowser', data)
                        this.setState(data);
                    })
                    //
                    // socket.emit('init', {});

                    socket.on('disconnect', () => {

                        log('disconnect: ' + n);
                    });

                    socket.emit('check')
                };

                socket.on('connect', connect);

            }
            onCut = id => {

                log('onCut', id);
            }
            render() {

                const {
                    tree,
                    valid,
                    invalidMsg,

                    clipboard,
                } = this.state;

                return (
                    <>
                        <button onClick={() => socket.emit('reset')}>reset</button>
                        <button onClick={() => socket.emit('fix')}>fix</button>
                        <button onClick={() => socket.emit('check')}>check integrity</button>
                        <span className={valid ? 'valid' : 'invalid'}>{valid ? 'valid...' : invalidMsg}</span>
                        <span>clipboard: {`>`}{clipboard}{`<`}</span>
                        <Level
                            tree={tree}
                            onCopy={id => this.setState({
                                clipboard: id
                            })}
                            onCut={id => this.onCut(id)}
                            onPasteAfter={targetId => log('after: ', clipboard, targetId)}
                            onPasteBefore={() => log('before')}
                            onPasteToStart={() => log('first child')}
                            onPasteToEnd={() => log('end child')}
                            onPasteToZeroN={() => log('zero n child')}
                            onDelete={id => socket.emit('onDelete', id)}

                            clipboard={clipboard}
                        />
                    </>
                );
            }
        }
        ReactDOM.render(
            <Root
            />,
            document.getElementById('app')
        );

        window.socket = socket;

    </script>
</body>
</html>